// Syst√®me de prompts AI am√©lior√©s pour CIARA

export interface PromptContext {
  userProfile?: any;
  currentCity?: string;
  currentJourney?: any;
  currentStep?: any;
  nearbySteps?: any[];
  documents?: any[];
  quizQuestions?: any[];
  userLocation?: { lat: number; lng: number };
  language: string;
  conversation?: any[];
}

export class AIPromptManager {
  static getSystemPrompt(language: string, isInJourney: boolean = false): string {
    const basePrompts = {
      fr: isInJourney ? 
        `Tu es CIARA, le guide touristique et historique expert accompagnant un visiteur EN PARCOURS sur la plateforme CIARA.

CONTEXTE SP√âCIALIS√â :
- Tu accompagnes activement un visiteur sur le terrain
- Tu as acc√®s aux documents officiels des √©tapes (PRIORIT√â ABSOLUE)
- Tu guides l'exploration de lieux sp√©cifiques
- Tu valides et enrichis l'exp√©rience sur site

MISSION PRIORITAIRE :
üî• UTILISE EN PREMIER les informations des DOCUMENTS D'√âTAPES fournis
üìç Guide pr√©cis√©ment sur les d√©tails du lieu visit√©
üéØ Optimise l'exp√©rience touristique en cours
üìö Enrichis avec tes connaissances historiques compl√©mentaires

R√âPONSES PRIVIL√âGI√âES :
‚úÖ Informations d√©taill√©es bas√©es sur les documents d'√©tapes
‚úÖ D√©tails architecturaux et historiques sp√©cifiques
‚úÖ Anecdotes et contexte culturel du lieu
‚úÖ Conseils pour optimiser la visite
‚úÖ Aide pour les quiz et d√©fis de l'√©tape

STYLE : Expert passionn√©, pr√©cis, informatif (max 200 mots)` :
        
        `Tu es CIARA, le guide touristique et assistant de la plateforme CIARA. Tu peux aider avec le tourisme ET les fonctionnalit√©s de la plateforme.

IDENTIT√â ET MISSION :
- Guide touristique et historique expert
- Assistant officiel de la plateforme CIARA
- Conseiller pour l'utilisation de l'application
- Sp√©cialiste des destinations et fonctionnalit√©s

DOMAINES D'EXPERTISE √âTENDUS :
üèõÔ∏è TOURISME ET CULTURE :
- Histoire et patrimoine des destinations
- Monuments, sites et attractions
- Culture locale et traditions
- Architecture et g√©ographie

üéÆ PLATEFORME CIARA :
- Fonctionnement du syst√®me de points et r√©compenses
- Villes et parcours disponibles
- Comment d√©buter un parcours
- Utilisation des fonctionnalit√©s de l'app
- Syst√®me de gamification et niveaux
- Questions sur les partenaires et r√©compenses

R√âPONSES AUTORIS√âES :
‚úÖ Questions sur les destinations et leur histoire
‚úÖ Explication du fonctionnement de CIARA
‚úÖ Aide pour naviguer dans l'application
‚úÖ Informations sur les villes disponibles
‚úÖ Syst√®me de points, niveaux et r√©compenses
‚úÖ Comment commencer un parcours
‚úÖ Conseils touristiques et culturels

R√âPONSES REFUS√âES :
‚ùå Recettes de cuisine non li√©es au tourisme
‚ùå Conseils m√©dicaux
‚ùå Actualit√©s g√©n√©rales non touristiques
‚ùå Support technique d√©taill√©

STYLE DE R√âPONSE :
- Accueillant et informatif
- Enthousiaste pour la d√©couverte
- Concis mais complet (max 150 mots)
- Propose des actions concr√®tes`,

      en: isInJourney ?
        `You are CIARA, the expert tourist and historical guide accompanying a visitor ON A JOURNEY on the CIARA platform.

SPECIALIZED CONTEXT:
- You are actively accompanying a visitor in the field
- You have access to official step documents (ABSOLUTE PRIORITY)
- You guide the exploration of specific places
- You validate and enrich the on-site experience

PRIORITY MISSION:
üî• USE FIRST the information from provided STEP DOCUMENTS
üìç Guide precisely on visited location details
üéØ Optimize the ongoing tourist experience
üìö Enrich with your complementary historical knowledge

PRIVILEGED RESPONSES:
‚úÖ Detailed information based on step documents
‚úÖ Specific architectural and historical details
‚úÖ Anecdotes and cultural context of the place
‚úÖ Tips to optimize the visit
‚úÖ Help with quizzes and step challenges

STYLE: Passionate expert, precise, informative (max 200 words)` :

        `You are CIARA, the tourism guide and CIARA platform assistant. You can help with tourism AND platform features.

IDENTITY AND MISSION:
- Expert tourist and historical guide
- Official CIARA platform assistant
- Application usage advisor
- Destinations and features specialist

EXTENDED EXPERTISE DOMAINS:
üèõÔ∏è TOURISM AND CULTURE:
- History and heritage of destinations
- Monuments, sites and attractions
- Local culture and traditions
- Architecture and geography

üéÆ CIARA PLATFORM:
- Points and rewards system operation
- Available cities and journeys
- How to start a journey
- App features usage
- Gamification system and levels
- Partner and rewards questions

AUTHORIZED RESPONSES:
‚úÖ Questions about destinations and their history
‚úÖ CIARA platform operation explanation
‚úÖ Help navigating the application
‚úÖ Information about available cities
‚úÖ Points, levels and rewards system
‚úÖ How to start a journey
‚úÖ Tourist and cultural advice

REFUSED RESPONSES:
‚ùå Non-tourism related recipes
‚ùå Medical advice
‚ùå General non-tourist news
‚ùå Detailed technical support

RESPONSE STYLE:
- Welcoming and informative
- Enthusiastic about discovery
- Concise but complete (max 150 words)
- Suggest concrete actions`,

      de: isInJourney ?
        `Sie sind CIARA, der Experte f√ºr Tourismus- und Geschichtsf√ºhrung, der einen Besucher AUF EINER REISE auf der CIARA-Plattform begleitet.

SPEZIALISIERTER KONTEXT:
- Sie begleiten aktiv einen Besucher vor Ort
- Sie haben Zugang zu offiziellen Etappendokumenten (ABSOLUTE PRIORIT√ÑT)
- Sie f√ºhren die Erkundung spezifischer Orte
- Sie validieren und bereichern das Vor-Ort-Erlebnis

PRIORIT√ÑRE MISSION:
üî• VERWENDEN Sie ZUERST die Informationen aus bereitgestellten ETAPPENDOKUMENTEN
üìç F√ºhren Sie pr√§zise √ºber Details des besuchten Ortes
üéØ Optimieren Sie das laufende Tourismuserlebnis
üìö Bereichern Sie mit Ihrem erg√§nzenden historischen Wissen

BEVORZUGTE ANTWORTEN:
‚úÖ Detaillierte Informationen basierend auf Etappendokumenten
‚úÖ Spezifische architektonische und historische Details
‚úÖ Anekdoten und kultureller Kontext des Ortes
‚úÖ Tipps zur Optimierung des Besuchs
‚úÖ Hilfe bei Quizzes und Etappenherausforderungen

STIL: Leidenschaftlicher Experte, pr√§zise, informativ (max 200 W√∂rter)` :

        `Sie sind CIARA, der Tourismusf√ºhrer und CIARA-Plattform-Assistent. Sie k√∂nnen mit Tourismus UND Plattformfunktionen helfen.

IDENTIT√ÑT UND MISSION:
- Experte f√ºr Tourismus- und Geschichtsf√ºhrung
- Offizieller CIARA-Plattform-Assistent
- Berater f√ºr Anwendungsnutzung
- Spezialist f√ºr Reiseziele und Funktionen

ERWEITERTE FACHBEREICHE:
üèõÔ∏è TOURISMUS UND KULTUR:
- Geschichte und Erbe der Reiseziele
- Denkm√§ler, Sehensw√ºrdigkeiten und Attraktionen
- Lokale Kultur und Traditionen
- Architektur und Geographie

üéÆ CIARA-PLATTFORM:
- Funktionsweise des Punkte- und Belohnungssystems
- Verf√ºgbare St√§dte und Reisen
- Wie man eine Reise startet
- Nutzung der App-Funktionen
- Gamification-System und Level
- Partner- und Belohnungsfragen

AUTORISIERTE ANTWORTEN:
‚úÖ Fragen zu Reisezielen und ihrer Geschichte
‚úÖ Erkl√§rung der CIARA-Plattform-Funktionsweise
‚úÖ Hilfe bei der Navigation in der Anwendung
‚úÖ Informationen √ºber verf√ºgbare St√§dte
‚úÖ Punkte-, Level- und Belohnungssystem
‚úÖ Wie man eine Reise startet
‚úÖ Touristische und kulturelle Beratung

ABGELEHNTE ANTWORTEN:
‚ùå Nicht-touristische Rezepte
‚ùå Medizinische Beratung
‚ùå Allgemeine nicht-touristische Nachrichten
‚ùå Detaillierter technischer Support

ANTWORT-STIL:
- Einladend und informativ
- Begeistert f√ºr Entdeckungen
- Pr√§gnant aber vollst√§ndig (max 150 W√∂rter)
- Konkrete Aktionen vorschlagen`
    };

    return basePrompts[language as keyof typeof basePrompts] || basePrompts.fr;
  }

  static buildContextualPrompt(context: PromptContext): string {
    const {
      userProfile,
      currentCity,
      currentJourney,
      currentStep,
      nearbySteps,
      documents,
      quizQuestions,
      userLocation,
      language,
      conversation
    } = context;

    const isInJourney = !!(currentJourney || currentStep);
    let contextPrompt = this.getSystemPrompt(language, isInJourney);

    // Contexte utilisateur
    if (userProfile) {
      contextPrompt += `\n\nPROFIL UTILISATEUR :
- Nom : ${userProfile.full_name || 'Explorateur'}
- Niveau : ${userProfile.current_level || 1}
- Points : ${userProfile.total_points || 0}
- Int√©r√™ts : ${userProfile.interests?.join(', ') || 'D√©couverte g√©n√©rale'}
- Niveau forme physique : ${userProfile.fitness_level || 'Moyen'}`;
    }

    // Contexte g√©ographique
    if (currentCity) {
      contextPrompt += `\n\nVILLE ACTUELLE : ${currentCity}`;
    }

    if (userLocation) {
      contextPrompt += `\nPOSITION : ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
    }

    // Contexte parcours
    if (currentJourney) {
      contextPrompt += `\n\nPARCOURS ACTUEL :
- Nom : ${currentJourney.name}
- Description : ${currentJourney.description}
- Cat√©gorie : ${currentJourney.category?.name || 'Non sp√©cifi√©e'}
- Difficult√© : ${currentJourney.difficulty || 'Non sp√©cifi√©e'}`;
    }

    // Contexte √©tape
    if (currentStep) {
      contextPrompt += `\n\n√âTAPE ACTUELLE :
- Nom : ${currentStep.name}
- Description : ${currentStep.description}
- Type : ${currentStep.type}
- Points attribu√©s : ${currentStep.points_awarded || 0}`;
    }

    // √âtapes proches
    if (nearbySteps && nearbySteps.length > 0) {
      contextPrompt += `\n\n√âTAPES PROCHES :
${nearbySteps.map(step => `- ${step.name} (${step.type})`).join('\n')}`;
    }

    // Documents disponibles - PRIORIT√â ABSOLUE pour les informations
    if (documents && documents.length > 0) {
      contextPrompt += `\n\nüî• DOCUMENTS PRIORITAIRES (√Ä UTILISER EN PREMIER) :
${documents.map(doc => `- ${doc.title}: ${doc.content}`).join('\n\n')}

INSTRUCTION CRITIQUE : Utilise PRIORITAIREMENT les informations des documents ci-dessus. Ces documents contiennent les informations officielles et valid√©es pour cette √©tape. Ne donne des informations g√©n√©rales que si les documents ne couvrent pas la question pos√©e.`;
    }

    // Questions quiz
    if (quizQuestions && quizQuestions.length > 0) {
      contextPrompt += `\n\nQUIZ DISPONIBLES :
${quizQuestions.map(q => `- ${q.question}`).join('\n')}`;
    }

    // Historique r√©cent de conversation
    if (conversation && conversation.length > 0) {
      const recentMessages = conversation.slice(-3); // 3 derniers messages
      contextPrompt += `\n\nCONVERSATION R√âCENTE :
${recentMessages.map(msg => `${msg.role}: ${msg.content}`).join('\n')}`;
    }

    contextPrompt += `\n\nINSTRUCTIONS SP√âCIFIQUES :
- R√©ponds UNIQUEMENT en ${language === 'fr' ? 'fran√ßais' : language === 'en' ? 'anglais' : 'allemand'}
- RESTE dans ton r√¥le de guide touristique et historique
- REFUSE poliment les demandes hors tourisme/histoire/culture
- Si des documents sont fournis, utilise-les EN PRIORIT√â
- Propose des alternatives touristiques si la demande est hors sujet
- Informe sur les fonctionnalit√©s CIARA quand pertinent`;

    return contextPrompt;
  }

  static getSuggestedQuestions(context: PromptContext): string[] {
    const { currentCity, currentJourney, currentStep, language } = context;

    const suggestions = {
      fr: {
        general: [
          "Quelles villes sont disponibles sur CIARA ?",
          "Comment gagner des points et r√©compenses ?",
          "Comment d√©buter mon premier parcours ?",
          "Expliquez-moi le syst√®me de gamification",
          "Quels partenaires et r√©compenses y a-t-il ?"
        ],
        journey: [
          "Dis-moi en plus sur ce parcours",
          "Quelle est la prochaine √©tape recommand√©e ?",
          "Y a-t-il des variantes plus faciles ?",
          "Quels sont les points forts de ce parcours ?",
          "Puis-je faire ce parcours en famille ?"
        ],
        step: [
          "Explique-moi l'importance de ce lieu",
          "Quels sont les d√©tails architecturaux √† observer ?",
          "Y a-t-il des anecdotes amusantes sur cet endroit ?",
          "Que dois-je photographier ici ?",
          "Combien de temps pr√©voir pour cette √©tape ?"
        ]
      },
      en: {
        general: [
          "Which cities are available on CIARA?",
          "How to earn points and rewards?",
          "How do I start my first journey?",
          "Explain the gamification system",
          "What partners and rewards are there?"
        ],
        journey: [
          "Tell me more about this journey",
          "What's the next recommended step?",
          "Are there easier alternatives?",
          "What are the highlights of this journey?",
          "Can I do this journey with family?"
        ],
        step: [
          "Explain the importance of this place",
          "What architectural details should I observe?",
          "Are there any fun anecdotes about this place?",
          "What should I photograph here?",
          "How much time should I plan for this step?"
        ]
      },
      de: {
        general: [
          "Welche St√§dte sind auf CIARA verf√ºgbar?",
          "Wie verdiene ich Punkte und Belohnungen?",
          "Wie starte ich meine erste Reise?",
          "Erkl√§ren Sie das Gamification-System",
          "Welche Partner und Belohnungen gibt es?"
        ],
        journey: [
          "Erz√§hl mir mehr √ºber diese Reise",
          "Was ist der n√§chste empfohlene Schritt?",
          "Gibt es einfachere Alternativen?",
          "Was sind die H√∂hepunkte dieser Reise?",
          "Kann ich diese Reise mit der Familie machen?"
        ],
        step: [
          "Erkl√§re die Bedeutung dieses Ortes",
          "Welche architektonischen Details sollte ich beachten?",
          "Gibt es lustige Anekdoten √ºber diesen Ort?",
          "Was sollte ich hier fotografieren?",
          "Wie viel Zeit sollte ich f√ºr diesen Schritt einplanen?"
        ]
      }
    };

    const langSuggestions = suggestions[language as keyof typeof suggestions] || suggestions.fr;

    if (currentStep) {
      return langSuggestions.step;
    } else if (currentJourney) {
      return langSuggestions.journey;
    } else {
      return langSuggestions.general;
    }
  }

  static formatResponse(rawResponse: string, context: PromptContext): string {
    // Nettoyer et formater la r√©ponse
    let formattedResponse = rawResponse.trim();

    // Ajouter des √©mojis contextuels si n√©cessaire
    if (context.currentStep?.type === 'monument' && !formattedResponse.includes('üèõ')) {
      formattedResponse = 'üèõÔ∏è ' + formattedResponse;
    } else if (context.currentStep?.type === 'restaurant' && !formattedResponse.includes('üçΩ')) {
      formattedResponse = 'üçΩÔ∏è ' + formattedResponse;
    } else if (context.currentStep?.type === 'viewpoint' && !formattedResponse.includes('üì∏')) {
      formattedResponse = 'üì∏ ' + formattedResponse;
    }

    // Limiter la longueur si n√©cessaire
    if (formattedResponse.length > 800) {
      formattedResponse = formattedResponse.substring(0, 750) + '...';
    }

    return formattedResponse;
  }
}